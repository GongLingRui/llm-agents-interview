# 大模型动力引擎-PyTorch性能和显存优化手册

前向传播是模型训练的前向计算过程，以计算损失函数(Loss)为终点；反向传播则是梯度计算过程；参数更新则是根据梯度方向对模型参数进行更新。这三个阶段的计算主要依赖于GPU设备。GPU设备的峰值浮点运算能力(peak FLOPS)和显存容量是单卡训练规模和速度的主要限制因素，也是优化的重点。因此，在第6章和第7章中，将分别介绍一些通用的单卡性能优化和显存优化技巧。

在本书中内存默认指代主内存，属于动态随机访问存储器(DRAM)。读者可能还听说过缓存(cache)的概念，缓存一般是静态随机访问存储器(SRAM)，其成本往往比DRAM高出许多，因此存储容量相对较小。缓存用于加速芯片内部的数据读写效率，其容量和读写速度需要与其他芯片单元的频率、计算效率相匹配，所以缓存往往属于芯片的一部分而不在主存当中。

对于主存来说，其核心性能指标包括以下三个部分：


• 内存容量：决定内存能够容纳的数据总量，经验上内存容量最好是GPU显存容量的两倍以上。


• 内存频率：决定了内存的读写效率。


• 通道数：注意这是主板的参数。双通道或者四通道内存读写，能够直接将内存带宽提高相应的倍数，配合软件支持可以将内存读写速度提高数倍。在购买内存时，商家有时还会特意标注DDR4、DDR5等内存规格。DDR4、DDR5描述了内存的技术标准、芯片组织结构以及控制算法等诸多细节。相较于DDR4, DDR5主要的性能提升在内存容量和带宽方面，在选购时我们需要关注主板的内存插槽是否支持相应规格的内存。


要衡量CPU的计算性能还需要关注流水线设计(pipeline)和指令发射数(issue width)，

除了执行计算之外，我们会发现CPU的指令流水中还有一个关键的步骤，就是内存数据的读取和写入。然而，与CPU的指令执行速度相比，内存的读写速度较慢，常常成为性能的瓶颈。为了解决这一问题，CPU提供了多级缓存来加速小规模数据的读写。现代CPU一般存在三级缓存结构，即L1、L2、L3缓存。尽管缓存的大小和速度对CPU性能有一定的间接影响，但在选择CPU时，缓存通常不是主要考虑的因素。


CPU技术是与时俱进的，在部分现代CPU中还会标注一种新参数，称为加速频率(boost clock)，在Intel CPU里也被称为睿频。这个加速频率相当于在基础CPU频率之上，加入了一个动态的频率范围——CPU在需要时自动超频，以提高计算效率。然而睿频的实际效果很大程度上取决于芯片功耗、调度算法的优化水平、芯片及系统的散热水平等多个因素，其性能提升程度不稳定。因此加速频率也不是CPU的重点参数，甚至在测试程序时间和性能的时候需要将其关闭确保测量结果的稳定[插图]。

这两种读写模式的效率一般会分别标注。随机读写模式的效率以硬盘的IOPS(input/output operations per second)为单位进行衡量；而连续传读写模式的效率则以MB/s(megabytes per second)为单位进行衡量。为什么两种读写模式的效率需要分别标注呢？这需要我们简单了解一下硬盘的工作原理。


从硬盘读取数据到内存实际上涉及两个步骤：从磁盘读取数据到缓冲区，以及从缓冲区传输数据到内存。其中从硬盘读取数据的启动延迟很高，也因此往往成为随机读写模式的瓶颈。而连续读写数据的效率则由硬盘连续读写速度、数据传输速度共同决定

• 硬盘容量：影响数据容量。


• 硬盘随机读写速度：影响频繁随机访问文本片段或小文件的速度。

• 硬盘连续读写速度：影响顺序访问数据的读写速度。


• 接口类型和协议：影响缓冲区到内存之间的传输速度。

因为GPU不仅擅长数值计算，其芯片设计上还专门为并行计算进行了特化。在训练系统中加入GPU之后，我们将原先放在CPU上的算子计算移到GPU上面。但是GPU的计算核心并不能直接从内存读取数据，于是在二者之间又加入了显存(VRAM)这个额外的存储元件。GPU计算核心与显存的关系可以简单理解为CPU核心与内存之间的关系。当需要在GPU上进行计算时，先要将张量数据从内存读取到显存，随后从显存读取数据到计算核心完成运算，而计算结果写回内存则会经历完全相反的过程。此时大部分的计算任务都放在了GPU上面，因此CPU主要承担相对轻量的数据预处理以及一些调度任务。在图2-5的基础上加入GPU后，硬件结构如图2-7所示。






